<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herramientas Web Futuristas</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter for a clean, modern look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Custom Styles for the futuristic look -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a0e1a; /* Deep dark blue background */
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(5, 150, 255, 0.1), transparent 25%),
                radial-gradient(circle at 85% 70%, rgba(100, 255, 218, 0.1), transparent 25%);
            color: #e0e0e0;
        }

        .card {
            background: rgba(17, 24, 39, 0.6); /* Semi-transparent dark card */
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 255, 255, 0.2);
            box-shadow: 0 0 25px rgba(0, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: rgba(0, 255, 255, 0.4);
            transform: translateY(-5px);
        }

        .input-field {
            background-color: #1f2937;
            border: 1px solid #4b5563;
            color: #e0e0e0;
            transition: all 0.3s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: #00ffff;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }

        .btn {
            background: linear-gradient(90deg, #00c6ff, #0072ff);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 198, 255, 0.2);
        }
        
        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 198, 255, 0.3);
        }

        .btn-secondary {
            background: #374151;
            box-shadow: none;
        }

        .btn-secondary:hover {
            background: #4b5563;
            transform: scale(1.05);
        }
        
        .result-box {
            background-color: #0c1222;
            border: 1px dashed #4b5563;
            min-height: 50px;
            font-family: 'Courier New', Courier, monospace;
            word-wrap: break-word;
        }
        
        /* UPDATED: Modern Calculator Styles */
        .calc-btn {
            background: rgba(41, 56, 78, 0.7); /* Darker, glassy blue */
            border: 1px solid rgba(0, 255, 255, 0.1);
            font-size: 1.25rem;
            padding: 1rem 0; /* Adjusted padding */
            border-radius: 0.75rem; /* rounded-xl */
            transition: all 0.2s ease-in-out;
            color: #e0e0e0;
            backdrop-filter: blur(5px);
        }

        .calc-btn:hover {
            background: rgba(56, 77, 105, 0.9);
            border-color: rgba(0, 255, 255, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 255, 255, 0.08);
        }

        .calc-btn:active, .calc-btn.keyboard-active {
            transform: translateY(0);
            background: rgba(70, 95, 130, 0.9);
        }

        .calc-operator {
            background: rgba(0, 108, 153, 0.6); /* Themed operator color */
            color: #99f6e4; /* Aqua text */
            font-weight: 500;
        }

        .calc-special {
            background: rgba(75, 85, 99, 0.6); /* Dark gray for C and DEL */
            color: #fca5a5; /* Light red text */
        }

        .calc-equals {
            background: linear-gradient(120deg, #00c6ff, #0072ff); /* Themed equals button */
            color: white;
            font-weight: 600;
        }

        #calculator-display {
            background: rgba(10, 14, 26, 0.8);
            border-bottom: 2px solid rgba(0, 255, 255, 0.3);
        }

        #calculator-history li {
            transition: background-color 0.2s ease;
        }

        #calculator-history li:hover {
            background-color: rgba(0, 255, 255, 0.05) !important;
        }

    </style>
</head>
<body class="min-h-screen w-full p-4 sm:p-8 flex flex-col items-center">

    <!-- Header -->
    <header class="text-center mb-12 w-full max-w-6xl">
        <div class="flex justify-between items-start">
             <!-- User Info: Date, Time, Flag -->
            <div id="userInfo" class="flex items-center justify-center sm:justify-start gap-4 mb-4 text-gray-400">
                <img id="user-flag" src="" alt="Bandera del país" class="w-8 h-auto rounded-md hidden" onerror="this.style.display='none'"/>
                <div class="text-sm text-left">
                    <span id="current-date" data-translate-key="current_date"></span>
                    <span id="current-time" class="block sm:inline-block sm:ml-2 font-mono bg-gray-800/50 px-2 py-1 rounded"></span>
                </div>
            </div>
            <!-- Language Selector -->
            <div class="relative">
                <select id="language-selector" class="input-field appearance-none p-2 rounded-lg pr-8">
                    <option value="es">Español</option>
                    <option value="en">English</option>
                </select>
            </div>
        </div>
        
        <h1 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 to-blue-500" data-translate-key="main_title">
            Digital Toolkit Pro
        </h1>
        <p class="text-lg text-gray-400 mt-2" data-translate-key="subtitle">Herramientas online útiles</p>
    </header>

    <!-- Main Grid for Tools -->
    <main class="w-full max-w-7xl grid grid-cols-1 lg:grid-cols-2 gap-8">
        
        <!-- Number/Text Converter Card -->
        <div class="card rounded-2xl p-6 md:p-8 space-y-8">
            <!-- Number to Text Section -->
            <div>
                <h2 class="text-2xl font-semibold mb-4 text-cyan-300" data-translate-key="num_to_text_title">Conversor de Número a Texto</h2>
                <div class="space-y-4">
                    <input type="number" id="numToTextInput" class="input-field w-full p-3 rounded-lg" data-translate-key-placeholder="num_to_text_placeholder">
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button id="toUpperBtn" class="btn-secondary w-full text-white font-semibold py-2 px-4 rounded-lg" data-translate-key="uppercase_btn">MAYÚSCULA</button>
                        <button id="toLowerBtn" class="btn-secondary w-full text-white font-semibold py-2 px-4 rounded-lg" data-translate-key="lowercase_btn">minúscula</button>
                    </div>
                    <div class="flex items-center gap-2">
                        <div id="numToTextResult" class="result-box p-4 rounded-lg text-cyan-200 w-full"></div>
                        <button id="copyNumToTextBtn" class="btn-secondary p-3 rounded-lg flex-shrink-0" data-translate-key-title="copy_result_title">
                            <svg class="clipboard-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Text to Number Section -->
            <div>
                <h2 class="text-2xl font-semibold mb-4 text-cyan-300" data-translate-key="text_to_num_title">Conversor de Texto a Número</h2>
                <div class="space-y-4">
                    <input type="text" id="textToNumInput" class="input-field w-full p-3 rounded-lg" data-translate-key-placeholder="text_to_num_placeholder">
                    <button id="textToNumBtn" class="btn w-full text-white font-bold py-3 px-4 rounded-lg" data-translate-key="convert_to_num_btn">Convertir a Número</button>
                    <div id="textToNumResult" class="result-box p-4 rounded-lg text-cyan-200"></div>
                </div>
            </div>
        </div>

        <!-- VAT Calculator Card -->
        <div class="card rounded-2xl p-6 md:p-8">
            <h2 class="text-2xl font-semibold mb-4 text-cyan-300" data-translate-key="vat_calculator_title">Calculadora de IVA</h2>
            <div class="space-y-6">
                <div>
                    <label for="countryVat" class="block mb-2 text-sm font-medium text-gray-300" data-translate-key="country_vat_label">País (IVA %)</label>
                    <select id="countryVat" class="input-field w-full p-3 rounded-lg"></select>
                </div>
                <div id="customVatContainer" class="hidden">
                    <label for="customVatInput" class="block mb-2 text-sm font-medium text-gray-300" data-translate-key="custom_vat_label">Ingresar % de IVA personalizado</label>
                    <input type="number" id="customVatInput" class="input-field w-full p-3 rounded-lg" data-translate-key-placeholder="custom_vat_placeholder">
                </div>
                <div>
                    <label for="amountInput" class="block mb-2 text-sm font-medium text-gray-300" data-translate-key="amount_label">Monto</label>
                    <input type="number" id="amountInput" class="input-field w-full p-3 rounded-lg" data-translate-key-placeholder="amount_placeholder">
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <button id="calculateFromNet" class="btn text-white font-bold py-3 px-4 rounded-lg" data-translate-key="calc_from_net_btn">Calcular desde Neto</button>
                    <button id="calculateFromTotal" class="btn text-white font-bold py-3 px-4 rounded-lg" data-translate-key="calc_from_total_btn">Calcular desde Total</button>
                </div>
                <div class="space-y-4 pt-4 border-t border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-200" data-translate-key="results_title">Resultados:</h3>
                    <div class="grid grid-cols-3 gap-2 text-center text-sm">
                        <div class="bg-gray-700/50 p-2 rounded"><span class="block text-xs text-gray-400" data-translate-key="net_label">Neto</span><span id="resultNet" class="font-mono text-lg text-cyan-300">-</span></div>
                        <div class="bg-gray-700/50 p-2 rounded"><span class="block text-xs text-gray-400" data-translate-key="vat_label">IVA</span><span id="resultVat" class="font-mono text-lg text-cyan-300">-</span></div>
                        <div class="bg-gray-700/50 p-2 rounded"><span class="block text-xs text-gray-400" data-translate-key="total_label">Total</span><span id="resultTotal" class="font-mono text-lg text-cyan-300">-</span></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modern Calculator -->
        <div class="card lg:col-span-2 rounded-2xl p-6 md:p-8">
            <h2 class="text-2xl font-semibold mb-4 text-cyan-300" data-translate-key="modern_calculator_title">Calculadora</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Calculator -->
                <div class="md:col-span-2">
                    <div id="calculator-display" class="text-right text-4xl p-4 rounded-t-lg font-mono break-all">0</div>
                    <div class="grid grid-cols-4 gap-2 mt-2">
                        <button class="calc-btn calc-special" data-key="clear">C</button>
                        <button class="calc-btn calc-special" data-key="backspace">DEL</button>
                        <button class="calc-btn calc-operator" data-key="%">%</button>
                        <button class="calc-btn calc-operator" data-key="/">÷</button>
                        <button class="calc-btn" data-key="7">7</button>
                        <button class="calc-btn" data-key="8">8</button>
                        <button class="calc-btn" data-key="9">9</button>
                        <button class="calc-btn calc-operator" data-key="*">×</button>
                        <button class="calc-btn" data-key="4">4</button>
                        <button class="calc-btn" data-key="5">5</button>
                        <button class="calc-btn" data-key="6">6</button>
                        <button class="calc-btn calc-operator" data-key="-">-</button>
                        <button class="calc-btn" data-key="1">1</button>
                        <button class="calc-btn" data-key="2">2</button>
                        <button class="calc-btn" data-key="3">3</button>
                        <button class="calc-btn calc-operator" data-key="+">+</button>
                        <button class="calc-btn col-span-2" data-key="0">0</button>
                        <button class="calc-btn" data-key=".">.</button>
                        <button class="calc-btn calc-equals" data-key="=">=</button>
                    </div>
                </div>
                <!-- History -->
                <div class="md:col-span-1">
                     <h3 class="text-lg font-semibold mb-2" data-translate-key="history_title">Historial</h3>
                     <div id="calculator-history" class="result-box h-48 p-2 rounded-lg space-y-1 overflow-y-auto">
                        <!-- History items will be injected here -->
                     </div>
                     <button id="clear-history-btn" class="btn-secondary w-full mt-2 py-2 rounded-lg text-sm" data-translate-key="clear_history_btn">Limpiar Historial</button>
                </div>
            </div>
        </div>

        <!-- Discount Calculator Card -->
        <div class="card rounded-2xl p-6 md:p-8">
            <h2 class="text-2xl font-semibold mb-4 text-cyan-300" data-translate-key="discount_calculator_title">Calculadora de Descuentos</h2>
            <div class="space-y-6">
                <div>
                    <label for="originalPriceInput" class="block mb-2 text-sm font-medium text-gray-300" data-translate-key="original_price_label">Precio Original</label>
                    <input type="number" id="originalPriceInput" class="input-field w-full p-3 rounded-lg" data-translate-key-placeholder="original_price_placeholder">
                </div>
                <div>
                    <label for="discountPercentageInput" class="block mb-2 text-sm font-medium text-gray-300" data-translate-key="discount_percentage_label">Porcentaje de Descuento (%)</label>
                    <input type="number" id="discountPercentageInput" class="input-field w-full p-3 rounded-lg" data-translate-key-placeholder="discount_percentage_placeholder">
                </div>
                <button id="calculateDiscountBtn" class="btn w-full text-white font-bold py-3 px-4 rounded-lg" data-translate-key="calculate_discount_btn">Calcular Descuento</button>
                <div class="space-y-4 pt-4 border-t border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-200" data-translate-key="results_title">Resultados:</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-center text-sm">
                        <div class="bg-gray-700/50 p-3 rounded-lg"><span class="block text-xs text-gray-400" data-translate-key="saved_amount_label">Monto Ahorrado</span><span id="savedAmount" class="font-mono text-xl text-green-400">-</span></div>
                        <div class="bg-gray-700/50 p-3 rounded-lg"><span class="block text-xs text-gray-400" data-translate-key="final_price_label">Precio Final</span><span id="finalPrice" class="font-mono text-xl text-cyan-300">-</span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Unit Converter Card -->
        <div class="card rounded-2xl p-6 md:p-8">
            <h2 class="text-2xl font-semibold mb-4 text-cyan-300" data-translate-key="unit_converter_title">Conversor de Unidades</h2>
            <div class="space-y-4">
                 <div>
                    <label for="unitCategory" class="block mb-2 text-sm font-medium text-gray-300" data-translate-key="measurement_type_label">Tipo de Medida</label>
                    <select id="unitCategory" class="input-field w-full p-3 rounded-lg"></select>
                </div>
                <div class="flex items-center gap-4">
                    <div class="w-full">
                        <label for="fromUnit" class="block mb-2 text-sm font-medium text-gray-300" data-translate-key="from_label">Desde</label>
                        <select id="fromUnit" class="input-field w-full p-3 rounded-lg"></select>
                    </div>
                    <div class="w-full">
                         <label for="toUnit" class="block mb-2 text-sm font-medium text-gray-300" data-translate-key="to_label">Hasta</label>
                        <select id="toUnit" class="input-field w-full p-3 rounded-lg"></select>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <input type="number" id="fromValue" class="input-field w-full p-3 rounded-lg" data-translate-key-placeholder="value_placeholder">
                    <input type="text" id="toValue" class="input-field w-full p-3 rounded-lg" readonly data-translate-key-placeholder="result_placeholder">
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="mt-12 text-center text-gray-500 text-sm">
        <p data-translate-key="footer_text">&copy; 2025 Digital Toolkit Pro</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // Declare all DOM element constants at the top of the scope.
            const userFlag = document.getElementById('user-flag');
            const currentDateEl = document.getElementById('current-date');
            const currentTimeEl = document.getElementById('current-time');
            const languageSelector = document.getElementById('language-selector');
            const numToTextInput = document.getElementById('numToTextInput');
            const toUpperBtn = document.getElementById('toUpperBtn');
            const toLowerBtn = document.getElementById('toLowerBtn');
            const numToTextResult = document.getElementById('numToTextResult');
            const copyNumToTextBtn = document.getElementById('copyNumToTextBtn');
            const textToNumInput = document.getElementById('textToNumInput');
            const textToNumBtn = document.getElementById('textToNumBtn');
            const textToNumResult = document.getElementById('textToNumResult');
            const countryVatSelect = document.getElementById('countryVat');
            const customVatContainer = document.getElementById('customVatContainer');
            const customVatInput = document.getElementById('customVatInput');
            const amountInput = document.getElementById('amountInput');
            const calculateFromNetBtn = document.getElementById('calculateFromNet');
            const calculateFromTotalBtn = document.getElementById('calculateFromTotal');
            const resultNet = document.getElementById('resultNet');
            const resultVat = document.getElementById('resultVat');
            const resultTotal = document.getElementById('resultTotal');
            const originalPriceInput = document.getElementById('originalPriceInput');
            const discountPercentageInput = document.getElementById('discountPercentageInput');
            const calculateDiscountBtn = document.getElementById('calculateDiscountBtn');
            const savedAmount = document.getElementById('savedAmount');
            const finalPrice = document.getElementById('finalPrice');
            const unitCategory = document.getElementById('unitCategory');
            const fromUnit = document.getElementById('fromUnit');
            const toUnit = document.getElementById('toUnit');
            const fromValue = document.getElementById('fromValue');
            const toValue = document.getElementById('toValue');
            const calculatorDisplay = document.getElementById('calculator-display');
            const calculatorButtons = document.querySelectorAll('.calc-btn');
            const calculatorHistory = document.getElementById('calculator-history');
            const clearHistoryBtn = document.getElementById('clear-history-btn');

            // --- DATA AND LOGIC ---
            
            const unitData = {
                longitud: { meters: 1, kilometers: 1000, centimeters: 0.01, millimeters: 0.001, miles: 1609.34, feet: 0.3048, inches: 0.0254 },
                masa: { grams: 1, kilograms: 1000, pounds: 453.592, ounces: 28.3495, tons: 1000000 },
                temperatura: { celsius: 'celsius', fahrenheit: 'fahrenheit', kelvin: 'kelvin' }
            };
            
            const translations = {
                es: {
                    main_title: "Digital Toolkit Pro",
                    subtitle: "Herramientas online útiles",
                    num_to_text_title: "Conversor de Número a Texto",
                    num_to_text_placeholder: "Ingresa un número...",
                    uppercase_btn: "MAYÚSCULA",
                    lowercase_btn: "minúscula",
                    copy_result_title: "Copiar resultado",
                    text_to_num_title: "Conversor de Texto a Número",
                    text_to_num_placeholder: "Ingresa un texto...",
                    convert_to_num_btn: "Convertir a Número",
                    vat_calculator_title: "Calculadora de IVA",
                    country_vat_label: "País (IVA %)",
                    custom_vat_label: "Ingresar % de IVA personalizado",
                    custom_vat_placeholder: "Ej: 25",
                    amount_label: "Monto",
                    amount_placeholder: "Ingresa el monto a calcular...",
                    calc_from_net_btn: "Calcular desde Neto",
                    calc_from_total_btn: "Calcular desde Total",
                    results_title: "Resultados:",
                    net_label: "Neto",
                    vat_label: "IVA",
                    total_label: "Total",
                    discount_calculator_title: "Calculadora de Descuentos",
                    original_price_label: "Precio Original",
                    original_price_placeholder: "Ej: 10000",
                    discount_percentage_label: "Porcentaje de Descuento (%)",
                    discount_percentage_placeholder: "Ej: 30",
                    calculate_discount_btn: "Calcular Descuento",
                    saved_amount_label: "Monto Ahorrado",
                    final_price_label: "Precio Final",
                    unit_converter_title: "Conversor de Unidades",
                    measurement_type_label: "Tipo de Medida",
                    from_label: "Desde",
                    to_label: "Hasta",
                    value_placeholder: "Valor...",
                    result_placeholder: "Resultado...",
                    footer_text: "© 2025 Digital Toolkit Pro",
                    measurement_types: { longitud: "Longitud", masa: "Masa", temperatura: "Temperatura" },
                    vat_countries: {
                        "0.19_cl": "Chile (19%)", "0.21_es": "España (21%)", "0.16_mx": "México (16%)", "0.21_ar": "Argentina (21%)", "0.19_co": "Colombia (19%)", "0.12_ec": "Ecuador (12%)", "0.18_pe": "Perú (18%)", "custom": "Otro (ingresar manualmente)..."
                    },
                    units: {
                        meters: 'Metros (m)', kilometers: 'Kilómetros (km)', centimeters: 'Centímetros (cm)', millimeters: 'Milímetros (mm)', miles: 'Millas (mi)', feet: 'Pies (ft)', inches: 'Pulgadas (in)',
                        grams: 'Gramos (g)', kilograms: 'Kilogramos (kg)', pounds: 'Libras (lb)', ounces: 'Onzas (oz)', tons: 'Toneladas (t)',
                        celsius: 'Celsius (°C)', fahrenheit: 'Fahrenheit (°F)', kelvin: 'Kelvin (K)'
                    },
                    modern_calculator_title: "Calculadora",
                    history_title: "Historial",
                    clear_history_btn: "Limpiar Historial",
                },
                en: {
                    main_title: "Digital Toolkit Pro",
                    subtitle: "Useful online tools",
                    num_to_text_title: "Number to Text Converter",
                    num_to_text_placeholder: "Enter a number...",
                    uppercase_btn: "UPPERCASE",
                    lowercase_btn: "lowercase",
                    copy_result_title: "Copy result",
                    text_to_num_title: "Text to Number Converter",
                    text_to_num_placeholder: "Enter text...",
                    convert_to_num_btn: "Convert to Number",
                    vat_calculator_title: "VAT Calculator",
                    country_vat_label: "Country (VAT %)",
                    custom_vat_label: "Enter custom VAT %",
                    custom_vat_placeholder: "Ex: 25",
                    amount_label: "Amount",
                    amount_placeholder: "Enter the amount to calculate...",
                    calc_from_net_btn: "Calculate from Net",
                    calc_from_total_btn: "Calculate from Total",
                    results_title: "Results:",
                    net_label: "Net",
                    vat_label: "VAT",
                    total_label: "Total",
                    discount_calculator_title: "Discount Calculator",
                    original_price_label: "Original Price",
                    original_price_placeholder: "Ex: 10000",
                    discount_percentage_label: "Discount Percentage (%)",
                    discount_percentage_placeholder: "Ex: 30",
                    calculate_discount_btn: "Calculate Discount",
                    saved_amount_label: "Amount Saved",
                    final_price_label: "Final Price",
                    unit_converter_title: "Unit Converter",
                    measurement_type_label: "Measurement Type",
                    from_label: "From",
                    to_label: "To",
                    value_placeholder: "Value...",
                    result_placeholder: "Result...",
                    footer_text: "© 2025 Digital Toolkit Pro",
                    measurement_types: { longitud: "Length", masa: "Mass", temperatura: "Temperature" },
                     vat_countries: {
                        "0.19_cl": "Chile (19%)", "0.21_es": "Spain (21%)", "0.16_mx": "Mexico (16%)", "0.21_ar": "Argentina (21%)", "0.19_co": "Colombia (19%)", "0.12_ec": "Ecuador (12%)", "0.18_pe": "Peru (18%)", "custom": "Other (enter manually)..."
                    },
                    units: {
                        meters: 'Meters (m)', kilometers: 'Kilometers (km)', centimeters: 'Centimeters (cm)', millimeters: 'Millimeters (mm)', miles: 'Miles (mi)', feet: 'Feet (ft)', inches: 'Inches (in)',
                        grams: 'Grams (g)', kilograms: 'Kilograms (kg)', pounds: 'Pounds (lb)', ounces: 'Ounces (oz)', tons: 'Tons (t)',
                        celsius: 'Celsius (°C)', fahrenheit: 'Fahrenheit (°F)', kelvin: 'Kelvin (K)'
                    },
                    modern_calculator_title: "Calculator",
                    history_title: "History",
                    clear_history_btn: "Clear History",
                }
            };
            
            let currentLang = 'es';
            const countryToLang = {
                'ES': 'es', 'MX': 'es', 'CO': 'es', 'AR': 'es', 'PE': 'es', 'VE': 'es', 'CL': 'es', 'EC': 'es', 'GT': 'es', 'CU': 'es', 'BO': 'es', 'HN': 'es', 'PY': 'es', 'SV': 'es', 'NI': 'es', 'CR': 'es', 'PA': 'es', 'UY': 'es', 'GQ': 'es',
                'US': 'en', 'GB': 'en', 'CA': 'en', 'AU': 'en', 'NZ': 'en'
            };

            // --- FUNCTION DEFINITIONS ---
            
            function setLanguage(lang) {
                if (!translations[lang]) return;
                currentLang = lang;
                document.documentElement.lang = lang;
                languageSelector.value = lang;

                document.querySelectorAll('[data-translate-key]').forEach(el => {
                    const key = el.getAttribute('data-translate-key');
                    el.textContent = translations[lang][key] || el.textContent;
                });
                
                document.querySelectorAll('[data-translate-key-placeholder]').forEach(el => {
                    const key = el.getAttribute('data-translate-key-placeholder');
                    el.placeholder = translations[lang][key] || el.placeholder;
                });

                 document.querySelectorAll('[data-translate-key-title]').forEach(el => {
                    const key = el.getAttribute('data-translate-key-title');
                    el.title = translations[lang][key] || el.title;
                });
                
                const unitCategorySelect = document.getElementById('unitCategory');
                const currentCategory = unitCategorySelect.value;
                unitCategorySelect.innerHTML = '';
                const measurementTypes = translations[lang].measurement_types;
                for (const key in measurementTypes) {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = measurementTypes[key];
                    unitCategorySelect.appendChild(option);
                }
                if (currentCategory) unitCategorySelect.value = currentCategory;
                populateUnits(); 

                const countryVat = document.getElementById('countryVat');
                const currentVat = countryVat.value;
                countryVat.innerHTML = '';
                const vatCountries = translations[lang].vat_countries;
                for (const key in vatCountries) {
                    const option = document.createElement('option');
                    option.value = key.split('_')[0];
                    option.textContent = vatCountries[key];
                    countryVat.appendChild(option);
                }
                if(currentVat) countryVat.value = currentVat;
            }

            const formatCurrency = (num, lang) => isNaN(num) ? '-' : num.toLocaleString(lang, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            const formatDate = (date) => date.toLocaleDateString(currentLang, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const formatTime = (date) => date.toLocaleTimeString(currentLang);

            function updateClock() {
                const now = new Date();
                currentDateEl.textContent = formatDate(now);
                currentTimeEl.textContent = formatTime(now);
            }
            
            async function initializeApp() {
                try {
                    const response = await fetch('https://ipinfo.io/json');
                    if (!response.ok) throw new Error('Network response was not ok.');
                    const data = await response.json();
                    const countryCode = data.country;
                    if (countryCode) {
                        userFlag.src = `https://flagcdn.com/w40/${countryCode.toLowerCase()}.png`;
                        userFlag.classList.remove('hidden');
                        const detectedLang = countryToLang[countryCode];
                        const browserLang = navigator.language.split('-')[0];
                        const finalLang = translations[detectedLang] ? detectedLang : (translations[browserLang] ? browserLang : 'es');
                        setLanguage(finalLang);
                    } else {
                        throw new Error("Country code not detected");
                    }
                } catch (error) {
                    console.error("No se pudo obtener la información de geolocalización:", error);
                    userFlag.classList.add('hidden');
                    const browserLang = navigator.language.split('-')[0];
                    setLanguage(translations[browserLang] ? browserLang : 'es');
                }
                updateClock();
                setInterval(updateClock, 1000);
            }

            function toWordsEN(num) { /* English conversion logic */ if(num===0)return'zero';const ones=['','one','two','three','four','five','six','seven','eight','nine'];const teens=['ten','eleven','twelve','thirteen','fourteen','fifteen','sixteen','seventeen','eighteen','nineteen'];const tens=['','','twenty','thirty','forty','fifty','sixty','seventy','eighty','ninety'];const scales=['','thousand','million','billion','trillion'];const numToStr=num.toString();if(numToStr.length>15)return"Number too large";const convertChunk=(chunk)=>{let words=[];let n=Number(chunk);if(n>=100){words.push(ones[Math.floor(n/100)],'hundred');n%=100;}if(n>=10&&n<=19){words.push(teens[n-10]);}else if(n>=20){words.push(tens[Math.floor(n/10)]);n%=10;if(n>0){words[words.length-1]+='-'+ones[n];}}else if(n>0){words.push(ones[n]);}return words.join(' ');};if(num<0)return"negative "+toWordsEN(Math.abs(num));let i=0;let result=[];while(num>0){let chunk=num%1000;if(chunk>0){let chunkWords=convertChunk(chunk.toString());result.unshift(chunkWords+(i>0?' '+scales[i]:''));}num=Math.floor(num/1000);i++;}return result.join(' ').trim();}
            function toWordsES(num) { /* Spanish conversion logic */ if(num===0)return'cero';function l(i,n,e,o){let r=e.length>3?e.substring(0,e.length-3):"",t=e.substring(e.length-3);if(r&&Number(r)>0)if(1===Number(r))i.push("un millón ");else{let e=c(r);"uno"===e.slice(-3)&&(e=e.slice(0,-3)+"un"),i.push(e+" millones ");}Number(t)>0&&(1===Number(t)?i.push("mil "):i.push(c(t).replace("uno","un")+" mil "))}function c(i){const n=["","ciento","doscientos","trescientos","cuatrocientos","quinientos","seiscientos","setecientos","ochocientos","novecientos"];if(100===Number(i))return"cien";return n[Math.floor(Number(i)/100)]+" "+e(i.substring(1))}function e(i){const n=["","","","treinta","cuarenta","cincuenta","sesenta","setenta","ochenta","noventa"];let e=Number(i);if(e<10)return o(i);if(e<16)return["diez","once","doce","trece","catorce","quince"][e-10];if(e<20)return"dieci"+o(String(e-10));if(e<30)return"veinti"+o(String(e-20));const r=e%10;return 0===r?n[Math.floor(e/10)]:n[Math.floor(e/10)]+" y "+o(String(r))}function o(i){return["cero","uno","dos","tres","cuatro","cinco","seis","siete","ocho","nueve"][Number(i)]}if(num<0)return"menos "+toWordsES(Math.abs(num));let i=String(num).length;if(i>15)return"Número demasiado grande";let n=[];for(let e=String(num);e.length>0;){let o=e.substring(Math.max(0,e.length-9));e=e.substring(0,Math.max(0,e.length-9)),l(n,o.length,o,i),i-=9}return n.join("").trim();}
            
            const convertNumToText = (casing) => {
                const value = numToTextInput.value;
                if(value === '') return;
                let text;
                if (currentLang === 'en') {
                    text = toWordsEN(Number(value));
                } else {
                    text = toWordsES(Number(value));
                }
                numToTextResult.textContent = casing === 'upper' ? text.toUpperCase() : text.toLowerCase();
            };

            function textoANumero(texto) { /* Unchanged */ const wordMap={'cero':0,'uno':1,'dos':2,'tres':3,'cuatro':4,'cinco':5,'seis':6,'siete':7,'ocho':8,'nueve':9,'diez':10,'once':11,'doce':12,'trece':13,'catorce':14,'quince':15,'dieciséis':16,'diecisiete':17,'dieciocho':18,'diecinueve':19,'veinte':20,'veintiuno':21,'veintidos':22,'veintitres':23,'veinticuatro':24,'veinticinco':25,'veintiseis':26,'veintisiete':27,'veintiocho':28,'veintinueve':29,'treinta':30,'cuarenta':40,'cincuenta':50,'sesenta':60,'setenta':70,'ochenta':80,'noventa':90,'cien':100,'ciento':100,'doscientos':200,'trescientos':300,'cuatrocientos':400,'quinientos':500,'seiscientos':600,'setecientos':700,'ochocientos':800,'novecientos':900};const scaleMap={'mil':1000,'millón':1000000,'millones':1000000};texto=texto.toLowerCase().replace(/ y /g,' ').replace(/ de /g,' ').trim();if(!texto)return 'Por favor, ingresa un texto.';const palabras=texto.split(/\s+/);let total=0;let grupoActual=0;for(let i=0;i<palabras.length;i++){const palabra=palabras[i];if(wordMap[palabra]!==undefined){grupoActual+=wordMap[palabra];}else if(scaleMap[palabra]!==undefined){const escala=scaleMap[palabra];if(grupoActual===0){grupoActual=1;}grupoActual*=escala;if(palabra==='mil'&&i+1<palabras.length&&(palabras[i+1]==='millón'||palabras[i+1]==='millones')){}else{total+=grupoActual;grupoActual=0;}}else{return `Palabra no reconocida: "${palabra}"`;}}total+=grupoActual;return total.toLocaleString(currentLang);}
            function getVatRate() { /* Unchanged */ const selection = countryVatSelect.value; if (selection === 'custom') { const customRate = parseFloat(customVatInput.value); return isNaN(customRate) ? 0 : customRate / 100; } else { return parseFloat(selection); } }
            
            function populateUnits() {
                const category = unitCategory.value;
                const unitKeys = Object.keys(unitData[category]);
                const translatedUnits = translations[currentLang].units;
                
                fromUnit.innerHTML = '';
                toUnit.innerHTML = '';

                unitKeys.forEach(key => {
                    const option1 = document.createElement('option');
                    option1.value = key;
                    option1.textContent = translatedUnits[key] || key;
                    fromUnit.appendChild(option1);

                    const option2 = document.createElement('option');
                    option2.value = key;
                    option2.textContent = translatedUnits[key] || key;
                    toUnit.appendChild(option2);
                });

                fromUnit.selectedIndex = 0;
                toUnit.selectedIndex = 1;
                
                convertUnits();
            }

            function convertUnits() {
                const category = unitCategory.value;
                const val = parseFloat(fromValue.value);
                const fromUKey = fromUnit.value;
                const toUKey = toUnit.value;
                
                if (isNaN(val) || !fromUKey || !toUKey) {
                    toValue.value = '';
                    return;
                }

                let result;

                if (category === 'temperatura') {
                    const fromType = unitData.temperatura[fromUKey];
                    const toType = unitData.temperatura[toUKey];
                    if (fromType === 'celsius') {
                        if (toType === 'fahrenheit') result = (val * 9/5) + 32;
                        else if (toType === 'kelvin') result = val + 273.15;
                        else result = val;
                    } else if (fromType === 'fahrenheit') {
                        if (toType === 'celsius') result = (val - 32) * 5/9;
                        else if (toType === 'kelvin') result = (val - 32) * 5/9 + 273.15;
                        else result = val;
                    } else if (fromType === 'kelvin') {
                        if (toType === 'celsius') result = val - 273.15;
                        else if (toType === 'fahrenheit') result = (val - 273.15) * 9/5 + 32;
                        else result = val;
                    }
                } else {
                    const fromFactor = unitData[category][fromUKey];
                    const toFactor = unitData[category][toUKey];
                    const baseValue = val * fromFactor;
                    result = baseValue / toFactor;
                }
                
                toValue.value = Number(result.toFixed(5)).toLocaleString(currentLang);
            }

            // --- MODERN CALCULATOR LOGIC ---
            let currentInput = '0';
            let history = [];

            function handleCalcInput(key) {
                const lastChar = currentInput.slice(-1);

                if (key === 'clear' || key === 'Escape') {
                    currentInput = '0';
                } else if (key === 'backspace' || key === 'Backspace') {
                    currentInput = currentInput.length > 1 ? currentInput.slice(0, -1) : '0';
                } else if (key === '=' || key === 'Enter') {
                    try {
                        const expression = currentInput.replace(/×/g, '*').replace(/÷/g, '/');
                        if (/[^0-9+\-*/.%() ]/.test(expression)) {
                            throw new Error("Invalid characters");
                        }
                        const rawResult = new Function('return ' + expression)();
                        const result = parseFloat(rawResult.toFixed(10));
                        history.push({ expression: currentInput, result: result.toLocaleString(currentLang), rawResult: result });
                        if (history.length > 10) history.shift();
                        updateHistory();
                        currentInput = String(result);
                    } catch (error) {
                        currentInput = 'Error';
                    }
                } else if (['+', '-', '×', '÷', '*', '/'].includes(key)) {
                    let operator = key;
                    if (key === '*') operator = '×';
                    if (key === '/') operator = '÷';
                    
                    if (!['+', '-', '×', '÷'].includes(lastChar)) {
                        currentInput += operator;
                    }
                } else if (key === '%') {
                    if (!isNaN(parseFloat(lastChar))){
                         currentInput = String(parseFloat(currentInput) / 100);
                    }
                } else if (!isNaN(key) || key === '.') {
                    if (key === '.' && currentInput.split(/[\+\-×÷]/).pop().includes('.')) return;
                    if (currentInput === '0' || currentInput === 'Error') {
                        currentInput = key;
                    } else {
                        currentInput += key;
                    }
                }
                updateDisplay();
            }

            function updateDisplay() {
                calculatorDisplay.textContent = currentInput;
            }

            function updateHistory() {
                calculatorHistory.innerHTML = '';
                history.slice().reverse().forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'p-1 rounded-md hover:bg-gray-700 cursor-pointer text-right text-sm';
                    li.innerHTML = `<span class="text-gray-400">${item.expression} =</span><br>${item.result}`;
                    li.addEventListener('click', () => {
                        currentInput = String(item.rawResult);
                        updateDisplay();
                    });
                    calculatorHistory.appendChild(li);
                });
            }

            // --- EVENT LISTENERS ---
            languageSelector.addEventListener('change', (e) => setLanguage(e.target.value));
            toUpperBtn.addEventListener('click', () => convertNumToText('upper'));
            toLowerBtn.addEventListener('click', () => convertNumToText('lower'));
            copyNumToTextBtn.addEventListener('click', () => {const textToCopy = numToTextResult.textContent;if (!textToCopy) return;const textArea = document.createElement('textarea');textArea.value = textToCopy;document.body.appendChild(textArea);textArea.select();try {document.execCommand('copy');const originalIcon = copyNumToTextBtn.innerHTML;copyNumToTextBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#34D399" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`;setTimeout(() => {copyNumToTextBtn.innerHTML = originalIcon;}, 1500);} catch (err) {console.error('Error al copiar el texto: ', err);}document.body.removeChild(textArea);});
            textToNumBtn.addEventListener('click', () => { const text = textToNumInput.value; const result = textoANumero(text); textToNumResult.textContent = result; });
            countryVatSelect.addEventListener('change', () => { if (countryVatSelect.value === 'custom') { customVatContainer.classList.remove('hidden'); } else { customVatContainer.classList.add('hidden'); } });
            calculateFromNetBtn.addEventListener('click', () => {const amount = parseFloat(amountInput.value);const vatRate = getVatRate();if (isNaN(amount) || vatRate <= 0) {resultNet.textContent = resultVat.textContent = resultTotal.textContent = '-';return;}const net = amount;const vat = net * vatRate;const total = net + vat;resultNet.textContent = formatCurrency(net, currentLang);resultVat.textContent = formatCurrency(vat, currentLang);resultTotal.textContent = formatCurrency(total, currentLang);});
            calculateFromTotalBtn.addEventListener('click', () => {const amount = parseFloat(amountInput.value);const vatRate = getVatRate();if (isNaN(amount) || vatRate <= 0) {resultNet.textContent = resultVat.textContent = resultTotal.textContent = '-';return;}const total = amount;const net = total / (1 + vatRate);const vat = total - net;resultNet.textContent = formatCurrency(net, currentLang);resultVat.textContent = formatCurrency(vat, currentLang);resultTotal.textContent = formatCurrency(total, currentLang);});
            calculateDiscountBtn.addEventListener('click', () => {const originalPrice = parseFloat(originalPriceInput.value);const discountPercentage = parseFloat(discountPercentageInput.value);if (isNaN(originalPrice) || isNaN(discountPercentage) || originalPrice < 0 || discountPercentage < 0) {savedAmount.textContent = '-';finalPrice.textContent = '-';return;}const amountToSave = originalPrice * (discountPercentage / 100);const priceWithDiscount = originalPrice - amountToSave;savedAmount.textContent = '$ ' + formatCurrency(amountToSave, currentLang);finalPrice.textContent = '$ ' + formatCurrency(priceWithDiscount, currentLang);});
            unitCategory.addEventListener('change', populateUnits);
            fromValue.addEventListener('input', convertUnits);
            fromUnit.addEventListener('change', convertUnits);
            toUnit.addEventListener('change', convertUnits);
            calculatorButtons.forEach(button => button.addEventListener('click', () => handleCalcInput(button.dataset.key)));
            clearHistoryBtn.addEventListener('click', () => { history = []; updateHistory(); });

            document.addEventListener('keydown', (event) => {
                // **FIX**: Check if the active element is an input/select field before hijacking keys.
                const activeEl = document.activeElement;
                if (activeEl && (activeEl.tagName === 'INPUT' || activeEl.tagName === 'SELECT')) {
                    return; // Don't interfere with typing in other input fields.
                }

                const key = event.key;
                let buttonKey;

                if (key >= '0' && key <= '9') buttonKey = key;
                else if (key === '.' || key === ',') buttonKey = '.';
                else if (['+', '-', '*', '/', '%'].includes(key)) buttonKey = key;
                else if (key === 'Enter' || key === '=') buttonKey = '=';
                else if (key === 'Backspace') buttonKey = 'backspace';
                else if (key === 'Escape') buttonKey = 'clear';

                if(buttonKey) {
                    event.preventDefault();
                    handleCalcInput(buttonKey);
                    const button = document.querySelector(`.calc-btn[data-key="${buttonKey}"]`) || document.querySelector(`.calc-btn[data-key="${key === '*' ? '×' : key === '/' ? '÷' : ''}"]`);
                    if(button) {
                        button.classList.add('keyboard-active');
                        setTimeout(() => button.classList.remove('keyboard-active'), 100);
                    }
                }
            });


            // --- INITIALIZATION ---
            initializeApp();

        });
    </script>
</body>
</html>

